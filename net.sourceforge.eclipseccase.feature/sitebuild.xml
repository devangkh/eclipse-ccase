<project name="eclipse-ccase-site" default="all">
		
	<target name="init-properties">
		<tstamp>
			<format property="release.date" pattern="MM/dd/yyyy"/>
		</tstamp>
		<xmlproperty file="${basedir}/feature.xml" collapseAttributes="true"/>
		<property file="login.properties"/>
				
		<property name="staging.dir" value="${basedir}/staging"/>
		<property name="features.dir" value="${staging.dir}/features"/>
		<property name="plugins.dir" value="${staging.dir}/plugins"/>
		
		<property name="feature.eclipse.dist.package" value="${staging.dir}/${feature.id}_${feature.version}.bin.dist.zip"/>
		<property name="feature.dist.package" value="${staging.dir}/${feature.id}_${feature.version}.zip"/>

		<property name="site.deploy.host" value="shell.sourceforge.net"/>	
		<property name="site.deploy.root" value="/home/groups/e/ec/eclipse-ccase/htdocs/update"/>
		<property name="site.url" value="http://eclipse-ccase.sourceforge.net/update"/>
		
		<fileset id="site.deploy.files" dir="${staging.dir}">
			<include name="site.xml"/>
			<include name="features/*"/>
			<include name="plugins/*"/>
		</fileset>
	</target>

	<target name="init-custom-tasks" depends="init-properties">
		<path id="tasks.classpath">
			<fileset dir="${basedir}/lib" includes="*.jar"/>
		</path>
		<!-- http://3sp.com/tutorials/j2ssh/sshanttask.htm -->
		<taskdef	name="ssh"
					classname="com.sshtools.ant.Ssh"
					classpathref="tasks.classpath"/>
		<!-- http://sfutils.sourceforge.net/ -->
		<taskdef 	name="sfpublish"
					classname="org.apache.tools.ant.taskdefs.optional.sourceforge.SourceForgePublish"
					classpathref="tasks.classpath"/>
	</target>
	
	<target name="init" depends="init-properties,init-custom-tasks">
	</target>
	
	<target name="clean" depends="init">
		<ant antfile="${basedir}/build.xml" target="clean"/>
		<delete dir="${staging.dir}" failonerror="false" quiet="true" />
	</target>
	
	<target name="all" depends="init,,build-feature,deploy-site,deploy-sf-release">
	</target>

	<target name="build-feature" depends="init">
		<mkdir dir="${staging.dir}"/>
		<mkdir dir="${staging.dir}/features"/>
		<mkdir dir="${staging.dir}/plugins"/>
		<copy file="${basedir}/site.xml" todir="${staging.dir}">
			<filterset begintoken="$${" endtoken="}">
				<filter token="feature.id" value="${feature.id}"/>
				<filter token="feature.version" value="${feature.version}"/>
				<filter token="site.url" value="${site.url}"/>
			</filterset>
		</copy>
		<ant antfile="${basedir}/build.xml" target="build.update.jar">
			<property name="plugin.destination" value="${plugins.dir}"/>
			<property name="feature.destination" value="${features.dir}"/>
		</ant>
		<ant antfile="${basedir}/build.xml" target="zip.distribution">
			<property name="feature.destination" value="${staging.dir}"/>
		</ant>
		<move file="${feature.eclipse.dist.package}" tofile="${feature.dist.package}"/>
	</target>
	
	<target name="deploy-site" depends="init,build-feature">
		<ssh	host="${site.deploy.host}"
				username="${user}"
				password="${password}"
				verifyhost="false">
			<sftp	action="put"
					depends="true"
					remotedir="${site.deploy.root}"
					skipFailedTransfers="true">
				<fileset refid="site.deploy.files"/>
			</sftp>
		</ssh>
	</target>
	
	<target name="deploy-sf-release" depends="init,build-feature">
		<sfpublish	releasename="${feature.version}"
					packagename="eclipse-ccase"
					packagehidden="no"
					hidden="no"
					projectshortname="eclipse-ccase"
					projectname="Clearcase plugin for Eclipse"
					username="${user}"
					password="${password}"
					releasedate="${release.date}">
        <filespec file="${feature.dist.package}" 
                  filetype="gzip_file" 
                  processortype="platform_independent"/>
      </sfpublish>
    </target>
    
</project>
